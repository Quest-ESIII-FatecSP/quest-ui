<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jogo de Quiz ‚Äî Jogador vs Jogador</title>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      color: white;
      overflow: hidden;
      background: #000 url('Fundo.jpeg') center center / cover no-repeat fixed;
    }

    .bg-style-intense {
      background-color: #2a0b2b;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,0.07) 25%, transparent 25%),
        linear-gradient(225deg, rgba(255,255,255,0.05) 25%, transparent 25%),
        radial-gradient(circle at 10% 10%, rgba(255,255,255,0.04), transparent 18%);
      background-size: 40px 40px, 40px 40px, 1000px 600px;
      background-position: 0 0, 20px 20px, center center;
      background-blend-mode: overlay, overlay, normal;
    }
    .bg-style-smooth {
      background-color: #301033;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,0.03) 25%, transparent 25%),
        linear-gradient(225deg, rgba(255,255,255,0.02) 25%, transparent 25%),
        radial-gradient(circle at 10% 10%, rgba(255,255,255,0.03), transparent 18%);
      background-size: 48px 48px, 48px 48px, 1000px 600px;
      background-position: 0 0, 24px 24px, center center;
      background-blend-mode: overlay, overlay, normal;
    }

    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(3,15,60,0.45), rgba(60,15,90,0.45));
      animation: bgshift 12s ease-in-out infinite alternate;
      z-index: -1;
    }
    @keyframes bgshift { 0% { background: linear-gradient(135deg, rgba(3,15,60,0.45), rgba(60,15,90,0.45)); } 100% { background: linear-gradient(135deg, rgba(10,40,100,0.45), rgba(90,20,120,0.45)); } }

    .hidden-icons img { position:absolute; left:-9999px; visibility:hidden }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 4px solid #FFD700;
      background-color: #021028;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-info img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
    }


    .player-info img,
    #player1-icon,
    #player2-icon {
      position: relative;
      display: inline-block;
      border-radius: 50%;
      box-shadow: 0 0 60px rgba(255,210,58,0.45), inset 0 0 0 6px rgba(0,0,0,0.35);
      transition: box-shadow .32s ease, transform .25s ease;
    }

    .player-info img::after,
    #player1-icon::after,
    #player2-icon::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 160%;
      height: 160%;
      background: radial-gradient(circle at 30% 20%, rgba(255,210,58,0.22), rgba(255,210,58,0.06) 35%, transparent 55%);
      filter: blur(16px);
      z-index: -1;
      border-radius: 50%;
      pointer-events: none;
    }

    @media (prefers-reduced-motion: reduce) {
      .player-info img, #player1-icon, #player2-icon { transition: none; }
      .player-info img::after, #player1-icon::after, #player2-icon::after { filter: blur(6px); }
    }

    .player-name {
      font-size: 16px;
      color: #ddd;
      margin-right: 6px;
    }

    .points {
      font-weight: bold;
      color: #FFD700;
      font-size: 18px;
    }

    .timer-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timer-container {
      position: relative;
      width: 60px;
      height: 60px;
    }

    .timer-circle {
      fill: none;
      stroke-width: 6;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke 0.2s linear;
    }

    .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      font-size: 18px;
    }

    #help-btn {
      background-color: #1a4cd7;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }

    #help-btn:hover { background-color: #163eb3; }

    #help-popup {
      display: none;
      position: absolute;
      top: 70px;
      right: 20px;
      background: #0b164d;
      border: 2px solid #FFD700;
      border-radius: 10px;
      padding: 15px;
      width: 220px;
      z-index: 20;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    }

    #help-popup button {
      background-color: #1a4cd7;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }

    #help-popup button:hover { background-color: #163eb3; }

    #game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 74px);
      text-align: center;
      gap: 20px;
    }

    .btn {
      background-color: #1a4cd7;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover { background-color: #163eb3; }

    #cards { position: fixed; inset:0; pointer-events:none; z-index:3; }
    .cards-side{ position:fixed; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:16px; }
    .cards-side.left{ left:16px; }
    .cards-side.right{ right:16px; }
    .cards-stack{ display:flex; flex-direction:row; column-gap:16px; }
    .cards-stack .cards-col{ display:flex; flex-direction:column; gap:16px; align-items:center; }
    .cards-side .card{ width:100px; height:150px; }
    @media (max-height: 860px){ .cards-side .card{ width:92px; height:138px; } }
    @media (max-height: 760px){ .cards-side .card{ width:86px; height:129px; } }
    @media (max-height: 680px){ .cards-side .card{ width:82px; height:124px; } }

    #category.centered-title{ width: 100%; text-align: center; font-weight: 700; }

    .card {
      width: 100px;
      height: 150px;
      background: linear-gradient(145deg, #1a1f4b, #0b0f30);
      border: 2px solid #FFD700;
      border-radius: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .card.card-used{
      background: linear-gradient(145deg, #fff1a8, #ffd23a);
      color: #000 !important;
      cursor: not-allowed;
      filter: saturate(1.05);
    }

    .card-inner {
      width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 600ms cubic-bezier(.2,.9,.3,1);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
    }
    .card-face { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; backface-visibility: hidden; border-radius: 12px; }
    .card-front { background: linear-gradient(145deg, #1a1f4b, #0b0f30); color: transparent; }
    .card-back { background: linear-gradient(145deg, #fff9e6, #ffd23a); color: #1a1200; transform: rotateY(180deg); font-weight:900; font-size:34px }
    .card-inner.flipped { transform: rotateY(180deg); }

    .card:hover {
      transform: translateY(-12px);
      box-shadow: 0 0 16px rgba(255, 215, 0, 0.45);
    }

    .card-vibe { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .card-vibe.vibrate { animation: vibrate 900ms infinite; }
    @keyframes vibrate {
      0% { transform: translateX(0) rotate(0.0deg); }
      25% { transform: translateX(-1.8px) rotate(-0.6deg); }
      50% { transform: translateX(0.8px) rotate(0.4deg); }
      75% { transform: translateX(-0.6px) rotate(-0.3deg); }
      100% { transform: translateX(0) rotate(0.0deg); }
    }


    #question-area {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      max-width: 720px;

      margin-top: -90px;
    }


    #question-box.fw-modal-like { width: clamp(480px, 85vw, 860px); padding-left:24px; padding-right:24px; }
    .qp-header{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px }
    .turn-title{ font-weight:700; color:#FFD700 }
    .current-player-title{ font-weight:600; color:#ddd }


    .cat-badge{
      display:inline-block;
      align-self:flex-start;
      padding:6px 12px;
      margin-bottom:8px;
      border-radius:999px;
      border:2px solid #FFD700;
      background: linear-gradient(145deg, #1a1f4b, #0b0f30);
      color:#FFD700;
      font-weight:700;
      font-size:14px;
      letter-spacing:.3px;
    }

    .question { font-size: 22px; font-weight: bold; }

    .answers {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }

    .answers button {
      background: #1a4cd7;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      overflow: hidden;
    }

    .answers button:disabled{
      opacity: .6;
      cursor: not-allowed;
      filter: grayscale(25%);
    }

    .answers button:hover { background-color: #163eb3; }

    .answers button.ans-correct{ background-color:#28a745 !important; color:#fff !important; }
    .answers button.ans-wrong{ background-color:#c0392b !important; color:#fff !important; }

    #waiting-screen {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .result-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      color: white;
      font-size: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      opacity: 0;
      transition: transform 0.25s ease, opacity 0.25s ease;
      z-index: 10;
    }

    .result-animation.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .result-animation.correct { background-color: rgba(0,200,0,0.85); }
    .result-animation.wrong { background-color: rgba(200,0,0,0.85); }

    :root{ --rot-size:320px; }
    .roleta-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px }
    .roleta{ width:320px; height:320px; position:relative; border-radius:50%; display:grid; place-items:center; }
    .disco{ width:100%; height:100%; border-radius:50%; background:transparent; display:grid; place-items:center; border:10px solid #ffd23a; box-shadow: 0 0 30px rgba(255,210,58,0.25); transform:rotate(0deg); transition: transform 5s cubic-bezier(.17,.89,.32,1.49); }
    .disco.idle{ animation: none }
    .miolo{ position:absolute; width:110px; height:110px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #2a2b3f, #0b0f1f 60%); border:6px solid rgba(0,0,0,0.5); box-shadow: inset 0 2px 12px #000a, 0 8px 18px rgba(0,0,0,.45); z-index:2}
    .girar-central{ position:absolute; z-index:5; top:50%; left:50%; transform:translate(-50%,-50%); width:84px; height:84px; border-radius:50%; display:grid; place-items:center; font-weight:800; cursor:pointer; border:6px solid rgba(0,0,0,0.25); color:#1a1200; background: linear-gradient(180deg,#ffd23a,#d4a200); }
    .pointer-top{ position:absolute; top:-6px; left:50%; transform:translateX(-50%); width:14px; height:14px; border-radius:50%; background:transparent; z-index:5 }

    #roletaModal > div { overflow: visible !important; }
    #roletaModal > div > div { overflow: visible !important; }
    #roletaIframe {
      width: 100%;
      height: 560px;
      border: 0;
      display: block;
      background: transparent;
      transform-origin: 50% 50%;
      animation: none !important;
      transform: none !important;
    }


    .confetti-container {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 0; pointer-events: none; overflow: visible;
      z-index: 10005;
    }
    .confetti {
      position: absolute; bottom: -12px; width: 10px; height: 16px; opacity: 0.95; border-radius: 2px;
      transform-origin: center;
      animation-name: confettiMove; animation-timing-function: cubic-bezier(.2,.7,.3,1); animation-fill-mode: forwards;
    }
    @keyframes confettiMove {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      60% { opacity: 1; }
      100% { transform: translateY(-110vh) rotate(720deg); opacity: 0; }
    }


    .fireworks-container{
      position: fixed;
      left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10010; overflow: visible;
    }
    .firework-rocket{
      position: absolute; bottom: 12px; width: 6px; height: 12px; border-radius: 3px; background: linear-gradient(180deg,#fff,#ffd23a);
      transform-origin: center bottom; box-shadow: 0 0 8px rgba(255,200,60,0.9);
    }
    .firework-particle{
      position: absolute; width: 8px; height: 8px; border-radius: 50%; opacity: 0; pointer-events: none;
      box-shadow: 0 0 10px rgba(255,255,255,0.9);
    }

    @keyframes fw-rocketUp {
      0% { transform: translateY(0) scale(1); opacity: 1 }
      80% { opacity: 1 }
      100% { transform: translateY(-62vh) scale(0.9); opacity: 0 }
    }

    @keyframes fw-particleFly {
      0% { transform: translate(0,0) scale(1); opacity: 1 }
      100% { transform: translate(var(--dx,0px), var(--dy,0px)) scale(0.6); opacity: 0 }
    }


    .fw-modal-content {
      background: linear-gradient(180deg,#111,#0e0e12);
      padding: 20px 22px;
      border-radius: 18px;
      border: 4px solid #FFD700;
      color: #fff;
      min-width: 360px;
      max-width: 680px;
      width: clamp(360px, 60vw, 680px);
      display: flex;
      gap: 18px;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    .fw-modal-content::before{
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: 20px;
      background: radial-gradient(circle at 30% 20%, rgba(255,210,58,0.06), transparent 40%);
      filter: blur(18px);
      z-index: -1;
      pointer-events: none;
    }
    .fw-modal-icon{
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 0 60px rgba(255,210,58,0.45), inset 0 0 0 6px rgba(0,0,0,0.35);
    }

    @media (max-width:520px){
      .fw-modal-content{ flex-direction: column; padding:16px; }
      .fw-modal-icon{ width:120px; height:120px; }
    }


    .fw-modal-like{
      background: linear-gradient(180deg,#111,#0e0e12);
      padding: 16px 18px 20px;
      border-radius: 18px;
      border: 4px solid #FFD700;
      color: #fff;
      width: clamp(420px, 82vw, 780px);
      position: relative;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      overflow: visible;
    }
    .fw-modal-like::before{
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: 20px;
      background: radial-gradient(circle at 30% 20%, rgba(255,210,58,0.06), transparent 40%);
      filter: blur(18px);
      z-index: -1;
      pointer-events: none;
    }

    #roletaOverlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.45); color:#fff; font-weight:800;
      font-size: clamp(16px, 2.8vw, 24px); text-align:center; text-shadow:0 2px 6px #000;
      z-index: 20;
    }
    #roletaIframe.dim{ filter: brightness(0.6) saturate(0.9); }


    /* Barra de poderes sempre vis√≠vel (z-index menor que roleta) */
    .power-tray{ position:fixed; left:0; right:0; bottom:18px; display:flex; z-index:3000; width:100%; }
    /* Roleta acima dos bot√µes */
    #roleta-area{ position:relative; z-index:6000; }
    .power-tray.center, .power-tray.left, .power-tray.right{ left:0; right:0; transform:none; }
    .power-row{ display:flex; align-items:center; justify-content:center; gap:42px; width:100%; }
    .powers-group{ display:flex; align-items:center; gap:14px }
    .power-btn{
      width:84px;
      height:84px;
      position: relative;
      border-radius:12px;
      border:2px solid #FFD700;
      color:#fff;
      cursor:pointer;
      background: linear-gradient(145deg, #1a1f4b, #0b0f30);
      box-shadow: 0 0 16px rgba(255, 215, 0, 0.25);
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:900;
      font-size:22px;
      overflow:hidden;
      transition: transform .22s ease, box-shadow .22s ease, filter .22s ease;
    }
    .power-btn:hover{ transform: translateY(-6px); box-shadow: 0 0 20px rgba(255, 215, 0, 0.38); filter: brightness(1.06) }
    .power-btn:disabled{ opacity:.6; cursor:not-allowed; filter: grayscale(25%); }
    .power-btn--freeze{ font-size:24px }
    .power-btn--steal{ background: linear-gradient(145deg, #fff1a8, #ffd23a); color:#1a1200; border-width:3px; box-shadow: 0 0 24px rgba(255,210,58,0.45); font-size:15px; line-height:1.15; font-weight:800; padding:6px 12px; text-align:center; }
    .power-btn--steal span{ display:block; text-align:center; }
    .power-btn img.power-icon{
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      margin: 0;
      padding: 0;
      border: 0;
      box-shadow: none;
      border-radius: inherit;
      transform: translateZ(0);
    }

    .power-btn.local-only.hidden-remote{ display:none !important; }

    #btn-steal{ position:relative; left:auto; bottom:auto; transform:none; z-index:1; }


    button.congelado {
      pointer-events: none;
      background: #b6e4ff !important;
      color: #ffffff !important;
      border: 1px solid #d7f2ff;
      opacity: 0.85;
      cursor: not-allowed !important;
      position: relative;
    }

    button.congelado::after {
      content: "";
      position: absolute;
      inset: 0;
      background-size: cover;
      opacity: 0.20;
      pointer-events: none;
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABf0lEQVR4nJWTP0vDUBCFv3mECmkRKJmQRJpISkXdwT4FEXtA0SJEqzVgoivQeC0F1A1YEMCh0hCEpCVSEi9sNjdUceub3vXvtnjO955x7zjmn6AgsF3FXOQWzK+o4xD48YpAI5X8C4Tt8pGjUXNAD+dZ8sfgQWbL7SRUH/CM8vTu1wlf4KpAxZpO+h3jwCJnFZufw8cQHpFQ+E+1SZSaaJpx1XJ1gC2MeF2tXc1aw+U3RyQn5kFgXTHvZgi8JsD2D34H4cjZKsdGR/2yZWRIbqKGeS6zS7j2bV9tZ3iJy1NhTj05WhuSa3NMVOD+cVPx1wHc4mRqjCmgPCmAZ4C6t5orSjeit4G8HbbwGmU0m8EzUZcYjHUV/2KMam2E7kLYJp3y5p1zHJ1bbJsVGPTBPVNOSGeAjGZkGcqDplJaoPydRO+3sBX0Y/XfAd/uOUjoUEdtZ4SwYa2QIabwA9+cgCe6ZqIqysHa+zVzGZvAEuSClAvs8C9ww8wr7zV+bHhgYt2FRvTc3mDTLON6tCr5H5f0N+tzE7TRb0cAAAAASUVORK5CYII=") !important;
    }




    @keyframes freezeGrow {
      from { transform: scale(0.1); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    @keyframes freezeCracks {
      from { opacity: 0; }
      to   { opacity: 0.40; }
    }

    #btn-steal.power-btn{ width: 100px; height: 100px; }
    @media (max-height: 760px){
      .power-btn{ width:72px; height:72px; font-size:20px }
      .power-btn--steal{ font-size:12px }
    }
    @media (max-height: 680px){
      .power-btn{ width:66px; height:66px; font-size:18px }
      .power-btn--steal{ font-size:11px }
    }

    /* Position the power-row near the central steal button.
       For player 1 (tray.left) the row is moved left of center;
       for player 2 (tray.right) the row is moved right of center.
       The steal button (#btn-steal) remains fixed centered. */
    /* Nova disposi√ß√£o: grupos flanqueando bot√£o roubar, tudo centralizado */
    .power-tray.center .power-row,
    .power-tray.left .power-row,
    .power-tray.right .power-row{ position:static; left:auto; bottom:auto; transform:none; }

    @media (max-width: 900px){
      .power-tray.left .power-row{ left: calc(50% - 160px); }
      .power-tray.right .power-row{ left: calc(50% + 100px); }
    }

    @media (max-width: 560px){
      .power-tray.left .power-row{ left: calc(50% - 120px); }
      .power-tray.right .power-row{ left: calc(50% + 80px); }
    }
  </style>
</head>

<div class="top-bar">
  <div class="player-info">
    <img id="player1-icon" src="https://i.pravatar.cc/50?img=3" />
    <span class="player-name" id="player1-name">Jogador1</span>
    <span class="points" id="player1-points">0 pts</span>
  </div>

  <div class="timer-area">
    <div class="timer-container">
      <svg width="60" height="60">
        <circle cx="30" cy="30" r="27" stroke="#333" />
        <circle id="timer-circle" class="timer-circle" cx="30" cy="30" r="27" stroke="#00FF00" stroke-dasharray="170" stroke-dashoffset="0" />
      </svg>
      <div id="timer-text" class="timer-text">15</div>
    </div>
    <button id="help-btn">Ajuda</button>
    <button id="backBtn" title="Voltar ao Lobby" [routerLink]="'/lobby'" style="margin-left:8px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:#2b2b5a;color:#fff">Voltar ao Lobby</button>
  </div>

  <div class="player-info">
    <img id="player2-icon" src="https://i.pravatar.cc/50?img=5" />
    <span class="player-name" id="player2-name">Jogador2</span>
    <span class="points" id="player2-points">0 pts</span>
  </div>
</div>

<div id="help-popup">
  <button>üí° Dica</button>
  <button>üë• Mudar pergunta</button>
  <button>‚è© Pular Quest√£o</button>
  <button>üìä Eliminar alternativa</button>
</div>

<div id="game-area">
  <div id="category" style="min-height:22px;"></div>
  <div id="roleta-area" style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:-40px;">
    <div class="fw-modal-like" style="overflow:visible;position:relative;">
      <iframe id="roletaIframe" src="roleta.html"></iframe>
      <div id="roletaOverlay">O oponente est√° girando a roleta</div>
    </div>
  </div>
  <div id="cards"></div>
  <div id="question-area">
    <div id="question-box" class="fw-modal-like" style="display:flex;flex-direction:column;gap:10px;">
      <div id="cat-badge" class="cat-badge" style="display:none"></div>
      <div class="qp-header">
        <div id="turn-title" class="turn-title"></div>
        <div id="current-player-title" class="current-player-title"></div>
      </div>
      <div class="question" id="question"></div>
      <div class="answers" id="answers"></div>
    </div>
  </div>
  <div id="waiting-screen">
    <h2 style="display:none"></h2>
    <p id="opponent-category" style="display:none"></p>
  </div>
</div>

<div id="result-animation" class="result-animation"></div>

<div id="power-tray" class="power-tray center" aria-label="Poderes dispon√≠veis">
  <div class="power-row">
    <div class="powers-group powers-left" data-side="left">
      <button class="power-btn power-btn--freeze local-only" id="btn-freeze" data-player="1" title="Congelar quest√£o">
        <img src="img/congelar.jpeg" alt="Congelar" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="1" title="Trocar alternativa correta">
        <img src="img/4cliques.jpeg" alt="4 Cliques" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="1" title="Jump Scare">
        <img src="img/jumpscare.jpeg" alt="Jump Scare" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="1" title="X Mask">
        <img src="img/x.jpeg" alt="X Mask" class="power-icon" />
      </button>
    </div>
    <button class="power-btn power-btn--steal" id="btn-steal" title="Roubar Pergunta" data-power="steal">
      <img src="img/roubarpergunta.jpeg" alt="Roubar Pergunta" class="power-icon" />
    </button>
    <div class="powers-group powers-right" data-side="right">
      <button class="power-btn power-btn--freeze local-only" data-player="2" title="Congelar quest√£o (Jogador 2)">
        <img src="img/congelar.jpeg" alt="Congelar" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="2" title="Trocar alternativa correta (Jogador 2)">
        <img src="img/4cliques.jpeg" alt="4 Cliques" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="2" title="Jump Scare (Jogador 2)">
        <img src="img/jumpscare.jpeg" alt="Jump Scare" class="power-icon" />
      </button>
      <button class="power-btn local-only" data-player="2" title="X Mask (Jogador 2)">
        <img src="img/x.jpeg" alt="X Mask" class="power-icon" />
      </button>
    </div>
  </div>
</div>

<script>
  const SFX = {};
  function loadAudio(id, src, loop=false, volume=1){ try{ const a = new Audio(src); a.loop = loop; a.volume = volume; SFX[id]=a; }catch(e){} }
  function playSFX(id){ try{ const a = SFX[id]; if(!a) return; a.currentTime = 0; a.play().catch(()=>{}); }catch(e){} }
  function stopSFX(id){ try{ const a = SFX[id]; if(!a) return; a.pause(); }catch(e){} }
  loadAudio('musica_quiz','sons/musica_quiz.m4a', true, 0.32);
  loadAudio('roleta','sons/roleta.m4a', false, 0.85);
  loadAudio('carta','sons/carta.m4a', false, 0.9);
  loadAudio('resposta_correta','sons/resposta_correta.m4a', false, 0.9);
  loadAudio('resposta_errada','sons/resposta_errada.m4a', false, 0.9);
  loadAudio('cronometro','sons/cronometro.m4a', true, 0.5);
  loadAudio('vencedor','sons/vencedor.m4a', false, 0.95);
  loadAudio('derrota','sons/derrota.m4a', false, 0.95);
  loadAudio('click','sons/click.m4a', false, 0.9);
  loadAudio('erro','sons/erro.m4a', false, 0.9);
  document.addEventListener('DOMContentLoaded',()=>{ playSFX('musica_quiz'); });
  const helpBtn = document.getElementById('help-btn');
  const helpPopup = document.getElementById('help-popup');
  helpBtn.addEventListener('click', () => {
    helpPopup.style.display = helpPopup.style.display === 'flex' ? 'none' : 'flex';
  });
  document.addEventListener('click', (e) => {
    if (!helpBtn.contains(e.target) && !helpPopup.contains(e.target)) helpPopup.style.display = 'none';
  });

  const backBtn = document.getElementById('backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      playSFX('click');
      window.location.href = 'players.html';
    });
  }

  // Definir localPlayerId antes de inicializar poderes para evitar aus√™ncia na primeira rodada
  const localPlayerId = (() => {
    try { return Math.max(1, Math.min(2, parseInt(new URLSearchParams(location.search).get('p')||'1', 10))); } catch(e){ return 1; }
  })();

  (function initFreezePower(){
    try{
      const freezeBtns = document.querySelectorAll(`.power-btn.power-btn--freeze.local-only[data-player="${localPlayerId}"]`);
      freezeBtns.forEach((freezeBtn)=>{
        if (freezeBtn) {
          freezeBtn.addEventListener('click', () => {
            try {
              const qa = document.getElementById('question-area');
              const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
              if (!isQuestionVisible) return;
              if (localPlayerId === currentPlayer) return;
              const payload = { by: localPlayerId, target: currentPlayer, at: Date.now(), durationMs: 5000 };
              localStorage.setItem('power_freeze', JSON.stringify(payload));
            } catch (e) {}
          });
        }
      });
    }catch(e){}
  })();

  (function initRunawayPower(){
    try{
      const localBtns = Array.from(document.querySelectorAll(`.powers-group .power-btn.local-only[data-player="${localPlayerId}"]`));
      const freeze = localBtns.find(b=> b.classList.contains('power-btn--freeze'));
      const others = localBtns.filter(b=> b !== freeze);
      const btn = others[0];
      if (btn) {
        if (!btn.id) btn.id = 'btn-runaway';
        btn.title = 'Quest√µes fogem do mouse';
        btn.addEventListener('click', () => {
          try {
            const qa = document.getElementById('question-area');
            const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
            if (!isQuestionVisible) return;
            if (localPlayerId === currentPlayer) return;
            const ctx = window._currentQuestionCtx || {};
            if (!ctx || !ctx.at) return;
            const payload = { by: localPlayerId, target: currentPlayer, qAt: ctx.at, at: Date.now(), clicks: 4 };
            localStorage.setItem('power_runaway', JSON.stringify(payload));
          } catch (e) {}
        });
      }
    }catch(e){}
  })();

  (function initJumpScarePower(){
    try{
      const localBtns = Array.from(document.querySelectorAll(`.powers-group .power-btn.local-only[data-player="${localPlayerId}"]`));
      const freeze = localBtns.find(b=> b.classList.contains('power-btn--freeze'));
      const others = localBtns.filter(b=> b !== freeze);
      const btn = others[1];
      if(btn){
        if(!btn.id) btn.id = 'btn-jumpscare';
        if(!btn.title) btn.title = 'Jump Scare (5s)';
        btn.addEventListener('click', ()=>{
          try{
            const qa = document.getElementById('question-area');
            const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
            if(!isQuestionVisible) return;
            if(localPlayerId === currentPlayer) return;
            const ctx = window._currentQuestionCtx || {};
            if(!ctx || !ctx.at) return;
            const payload = { by: localPlayerId, target: currentPlayer, qAt: ctx.at, at: Date.now(), durationMs: 5000 };
            localStorage.setItem('power_jumpscare', JSON.stringify(payload));
          }catch(e){}
        });
      }
    }catch(e){}
  })();

  (function initXBlockPower(){
    try{
      const localBtns = Array.from(document.querySelectorAll(`.powers-group .power-btn.local-only[data-player="${localPlayerId}"]`));
      const freeze = localBtns.find(b=> b.classList.contains('power-btn--freeze'));
      const others = localBtns.filter(b=> b !== freeze);
      const btn = others[2];
      if(btn){
        if(!btn.id) btn.id = 'btn-xmask';
        if(!btn.title) btn.title = 'X (5s)';
        btn.addEventListener('click', ()=>{
          try{
            const qa = document.getElementById('question-area');
            const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
            if(!isQuestionVisible) return;
            if(localPlayerId === currentPlayer) return;
            const ctx = window._currentQuestionCtx || {};
            if(!ctx || !ctx.at) return;
            const payload = { by: localPlayerId, target: currentPlayer, qAt: ctx.at, at: Date.now(), durationMs: 5000 };
            localStorage.setItem('power_xmask', JSON.stringify(payload));
          }catch(e){}
        });
      }
    }catch(e){}
  })();

  (function initStealPower(){
    try{
      const btn = document.getElementById('btn-steal');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        try{
          const qa = document.getElementById('question-area');
          const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
          if(!isQuestionVisible) return;
          // Somente o oponente pode roubar
          if(localPlayerId === currentPlayer) return;
          const raw = localStorage.getItem('sync_question');
          if(!raw) return;
          const q = JSON.parse(raw||'{}');
          if(!q || !q.category) return;
          if(q.stolenFrom){ return; } // j√° houve roubo nesta pergunta
          if(q.by === localPlayerId) return;
          // Marcar roubo √∫nico: de quem era, por quem foi roubado, sem alterar o tempo
          q.stolenFrom = q.by;
          q.stolenBy = localPlayerId;
          q.by = localPlayerId;
          localStorage.setItem('sync_question', JSON.stringify(q));
          // Re-render local (mesma aba n√£o recebe evento storage)
          try{ currentPlayer = localPlayerId; }catch(e){}
          try{ renderQuestionPayload(q); }catch(e){}
          try{ updateTurnUI(); }catch(e){}
          try{ setPowerTrayVisible(true); }catch(e){}
        }catch(e){}
      });
    }catch(e){}
  })();


  try{
    const stored1 = localStorage.getItem('selectedAvatar1') || localStorage.getItem('selectedAvatar');
    const stored2 = localStorage.getItem('selectedAvatar2');
    if(stored1){
      const p1 = document.getElementById('player1-icon');
      if(p1) p1.src = stored1;
    }
    if(stored2){
      const p2 = document.getElementById('player2-icon');
      if(p2) p2.src = stored2;
    }
  }catch(e){ }

  try{
    window.addEventListener('storage', (ev) => {
      if(!ev) return;
      try{
        if(ev.key === 'selectedAvatar' || ev.key === 'selectedAvatar1'){
          const newSrc = ev.newValue;
          const p1 = document.getElementById('player1-icon');
          if(p1 && newSrc) p1.src = newSrc;
        }
        if(ev.key === 'selectedAvatar2'){
          const newSrc = ev.newValue;
          const p2 = document.getElementById('player2-icon');
          if(p2 && newSrc) p2.src = newSrc;
        }
      }catch(e){}
    });
  }catch(e){ }

  let currentPlayer = 1;
  let points = {1: 0, 2: 0};
  let timer, timeLeft = 15;
  let spectatorTimer = null;

  let usedCardsCache = { 1: [], 2: [] };

  let roundCount = 0;

  function finalizeIfRoundLimitOrWinner(){
    if(points[1] >= 15 || points[2] >= 15) return;
    if(roundCount >= 5){
      let winnerId;
      if(points[1] === points[2]){
        winnerId = 1;
      } else {
        winnerId = (points[1] > points[2]) ? 1 : 2;
      }
      const winner = { id: winnerId, name: document.getElementById(`player${winnerId}-name`).textContent, pts: points[winnerId] };
      showFinalWinner(winner);
    }
  }

  const questions = {
    Science: [{question: "Qual planeta √© conhecido como o Planeta Vermelho?", answers: ["V√™nus", "Marte", "J√∫piter", "Saturno", "Merc√∫rio"], correct: 1}],
    History: [{question: "Quem descobriu a Am√©rica?", answers: ["Crist√≥v√£o Colombo", "Fern√£o de Magalh√£es", "Am√©rico Vesp√∫cio", "James Cook", "Marco Polo"], correct: 0}],
    Sports: [{question: "Quantos jogadores tem um time de futebol?", answers: ["9", "10", "11", "12", "13"], correct: 2}],
    Art: [{question: "Quem pintou a Mona Lisa?", answers: ["Picasso", "Van Gogh", "Leonardo da Vinci", "Michelangelo", "Rembrandt"], correct: 2}],
    Movies: [{question: "Em qual filme aparece a frase 'I'll be back'?", answers: ["Rocky", "Predador", "Exterminador do Futuro", "Matrix", "Rambo"], correct: 2}]
  };


  function clearMatchState(){
    try{
      const keys = ['sync_roleta','sync_roleta_spin','sync_card','sync_question','sync_answer','matchResult','goLobbyNow','rematchNow','rematchRequest','rematchResponse','used_cards','used_cards_1','used_cards_2'];
      keys.forEach(k => localStorage.removeItem(k));
    }catch(e){}
  }


  function maybeClearStaleState(){
    try{

      if(sessionStorage.getItem('freshBoot') === '1') return;
      sessionStorage.setItem('freshBoot','1');
      const now = Date.now();
      const get = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(e){ return null; } };
      const q = get('sync_question');
      const r = get('sync_roleta');
      const s = get('sync_roleta_spin');
      const a = get('sync_answer');
      const m = get('matchResult');
      const recent = (o,ms)=> o && typeof o.at==='number' && (now - o.at) < ms;
      const hasActiveRecent = recent(q, 120000) || recent(r, 120000) || recent(s, 120000) || recent(a, 120000);
      if(m && !hasActiveRecent){
        clearMatchState();
      }
    }catch(e){}
  }


  function applyNewMatchSignal(){
    try{
      const nm = localStorage.getItem('newMatch');
      if(!nm) return;
      const appliedKey = 'newMatchApplied_'+localPlayerId;
      const already = localStorage.getItem(appliedKey);
      if(already === nm) return;
      clearMatchState();
      localStorage.setItem(appliedKey, nm);
    }catch(e){}
  }


  function englishToPt(cat){
    const map = { 'Science':'Ci√™ncias', 'History':'Sociedade', 'Sports':'Esportes', 'Art':'Artes', 'Movies':'Mundo' };
    return map[cat] || cat;
  }


  function renderQuestionPayload(payload){
    try{
      if(!payload) return;
      const { category, question, answers, correct, pointsValue, by } = payload;
      try{ currentPlayer = by || currentPlayer; }catch(e){}

      try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
      try{ const cd = document.getElementById('cards'); if(cd) cd.style.display = 'block'; }catch(e){}
      try{ const cd = document.getElementById('cards'); if(cd) cd.style.pointerEvents = 'none'; }catch(e){}

      const qa = document.getElementById('question-area');
      if(qa) qa.style.display = 'flex';
      playSFX('click');
      try{ setPowerTrayVisible(true); }catch(e){}
      try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 0); }catch(e){}
      try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 60); }catch(e){}
      try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 240); }catch(e){}

      const turnTitle = document.getElementById('turn-title');
      const curTitle = document.getElementById('current-player-title');
      const nameEl = document.getElementById(`player${by}-name`);
      const byName = (nameEl && nameEl.textContent) ? nameEl.textContent : `Jogador ${by}`;
      if(localPlayerId === by){
        if(turnTitle) turnTitle.textContent = 'Agora √© sua vez, responda:';
      } else {
        if(turnTitle) turnTitle.textContent = 'Oponente est√° respondendo...';
      }
      if(curTitle) curTitle.textContent = `Jogador da vez: ${byName}`;

      try{
        const tray = document.getElementById('power-tray');
        if(tray){
          tray.style.display = 'flex';
          tray.classList.remove('center','left','right');
          tray.classList.add('center');
          const isOpponentView = (localPlayerId !== by);
          const stealUsed = !!payload.stolenFrom;
          const localOnlyButtons = tray.querySelectorAll('.power-btn.local-only');
          localOnlyButtons.forEach(btn=>{
            try{
              const btnPlayer = btn.getAttribute('data-player');
              btn.classList.remove('hidden-remote');
              btn.style.display = '';
              if(isOpponentView && btnPlayer === String(localPlayerId)){
                btn.disabled = false;
              } else {
                btn.disabled = true;
              }
            }catch(e){}
          });
          const stealBtn = tray.querySelector('#btn-steal');
          if(stealBtn){
            stealBtn.style.display = '';
            // Habilitar somente para o oponente e apenas se ainda n√£o foi usado nesta pergunta
            stealBtn.disabled = (!isOpponentView) || stealUsed;
          }
        }
      }catch(e){}

      try{
        const catEl = document.getElementById('category');
        if(catEl){ catEl.classList.remove('centered-title'); catEl.innerText = ''; }
        const badge = document.getElementById('cat-badge');
        if(badge){ badge.style.display = 'inline-block'; badge.textContent = `Categoria: ${englishToPt(category)}`; }
      }catch(e){}

      const qEl = document.getElementById('question');
      const ansDiv = document.getElementById('answers');
      if(qEl) qEl.textContent = question || '';
      if(ansDiv){
        ansDiv.innerHTML = '';
        (answers||[]).forEach((ans, idx)=>{
          const btn = document.createElement('button');
          btn.innerText = ans;
          btn.dataset.idx = String(idx);
          if(localPlayerId !== by){
            btn.disabled = true;
          } else {
            btn.onclick = () => { if(localPlayerId !== currentPlayer) return; answerQuestion(idx === correct, pointsValue, category, idx, correct); };
          }
          ansDiv.appendChild(btn);
        });
        try{
          const freezeRaw = localStorage.getItem('power_freeze');
          if(freezeRaw){
            const f = JSON.parse(freezeRaw||'{}');
            if(f && f.target === currentPlayer && localPlayerId === currentPlayer){
              const since = Date.now() - f.at;
              const remaining = (f.durationMs||5000) - since;
              if(remaining > 0){
                const btns = Array.from(ansDiv.querySelectorAll('button'));
                btns.forEach(b=> b.disabled = true);
                setTimeout(()=>{
                  try{
                    const qa = document.getElementById('question-area');
                    const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
                    if(isQuestionVisible && currentPlayer === f.target){
                      btns.forEach(b=> b.disabled = false);
                    }
                  }catch(e){}
                }, remaining);
              }
            }
          }
        }catch(e){}
      }


      const startedAt = payload.at || Date.now();
      const elapsed = Math.max(0, Math.floor((Date.now() - startedAt)/1000));
      const remaining = Math.max(0, 15 - elapsed);

      try{ window._currentQuestionCtx = { correct, pointsValue, category, by, at: startedAt, stolenFrom: payload.stolenFrom, stolenBy: payload.stolenBy }; }catch(e){}

      if(localPlayerId === by){
        try{ clearInterval(timer); }catch(e){}
        try{ if(spectatorTimer) { clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
        startTimerRemaining(remaining);
      } else {
        try{ if(timer) { clearInterval(timer); } }catch(e){}
        startSpectatorTimerRemaining(remaining);
      }
    }catch(e){ console.warn('renderQuestionPayload error', e); }
  }

  function updateTurnUI(){
    try{
      const qa = document.getElementById('question-area');
      const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
      const ro = document.getElementById('roleta-area');
      if(ro){
        if(isQuestionVisible){ ro.style.display = 'none'; } else { ro.style.display = 'flex'; }
      }
      try{
        const iframe = document.getElementById('roletaIframe');
        if(iframe && iframe.contentWindow){
          iframe.contentWindow.postMessage({ type:'setSpinEnabled', enabled: (localPlayerId === currentPlayer) }, '*');
          const overlay = document.getElementById('roletaOverlay');
          if(overlay) overlay.style.display = (localPlayerId === currentPlayer) ? 'none' : 'flex';
          if(iframe){ if(localPlayerId !== currentPlayer) iframe.classList.add('dim'); else iframe.classList.remove('dim'); }
        }
      }catch(e){}
      const btn = document.getElementById('openRoletaBtn');
      if(btn) btn.disabled = isQuestionVisible || !(localPlayerId === currentPlayer);
      const waiting = document.getElementById('waiting-screen');
      const oppCat = document.getElementById('opponent-category');
      if(isQuestionVisible){
        if(waiting) waiting.style.display = 'none';
        if(oppCat) oppCat.innerText = '';
        try{ setPowerTrayVisible(true); }catch(e){}
      } else {
        if(localPlayerId !== currentPlayer){
          if(waiting) waiting.style.display = 'none';
          if(oppCat) oppCat.innerText = '';
          try{ setPowerTrayVisible(false); }catch(e){}
        } else {
          if(waiting) waiting.style.display = 'none';
          if(oppCat) oppCat.innerText = '';
          try{ setPowerTrayVisible(false); }catch(e){}
        }
      }
    }catch(e){}
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{ maybeClearStaleState(); }catch(e){}
    try{ applyNewMatchSignal(); }catch(e){}
    updateTurnUI();
    try{ hydrateFromStorage(); }catch(e){}
    // Monitor para garantir que poderes apare√ßam para p=2 (corrige casos de corrida).
    try{
      if(!window._powerTrayWatch){
        window._powerTrayWatch = setInterval(()=>{
          if(window._gameEnded) return; // n√£o reexibir ap√≥s fim de jogo
          try{
            const tray = document.getElementById('power-tray');
            const qa = document.getElementById('question-area');
            const isQuestionVisible = qa && window.getComputedStyle(qa).display !== 'none';
            if(isQuestionVisible && tray && tray.style.display === 'none'){
              setPowerTrayVisible(true);
            }
          }catch(e){}
        }, 600);
      }
    }catch(e){}
  });

  (function(){
    const openBtn = document.getElementById('openRoletaBtn');
    const iframe = document.getElementById('roletaIframe');
    const overlay = document.getElementById('roletaOverlay');

    function showModal(){
      try{ iframe.setAttribute('scrolling','no'); iframe.style.overflow = 'hidden'; }catch(e){}
      try{
        const isMyTurn = (localPlayerId === currentPlayer);
        if(overlay){ overlay.style.display = isMyTurn ? 'none' : 'flex'; }
        if(iframe){ if(isMyTurn) iframe.classList.remove('dim'); else iframe.classList.add('dim'); }
        try{ iframe.contentWindow.postMessage({ type:'setSpinEnabled', enabled: isMyTurn }, '*'); }catch(e){}
        try{ iframe.contentWindow.postMessage({ type:'resetWheel' }, '*'); }catch(e){}
      }catch(e){}
    }
    function hideModal(){
      try{ if(overlay) overlay.style.display = 'none'; }catch(e){}
      try{ if(iframe) iframe.classList.remove('dim'); }catch(e){}
    }

    if(openBtn){
      openBtn.addEventListener('click', ()=>{
        if (localPlayerId !== currentPlayer) return;
        showModal();
        try{ iframe.src = 'roleta.html?_=' + Date.now(); }catch(e){ console.warn('Failed to set iframe src', e); }
      });
    }

    window.addEventListener('message', (e)=>{
      try{
        const data = e.data || {};
        if(data && data.type === 'roletaSpinStarted'){
          if(localPlayerId !== currentPlayer) return;
          try{ window._spinInProgress = true; }catch(e){}
          try{ const cd = document.getElementById('cards'); if(cd) cd.style.display = 'none'; }catch(e){}
          try{ localStorage.setItem('sync_roleta_spin', JSON.stringify({ index: data.index, turns: data.turns, duration: data.duration, by: currentPlayer, at: Date.now() })); }catch(err){}
          playSFX('roleta');
          return;
        }
        if(data && data.type === 'roletaResult'){
          try{ window._spinInProgress = false; }catch(e){}
          const category = data.category || '';
          const pointsValue = (typeof data.points === 'number' && data.points > 0) ? data.points : (Math.floor(Math.random()*5) + 1);
          setTimeout(()=>{
            try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
            try{ const cd = document.getElementById('cards'); if(cd) cd.style.display = 'block'; }catch(e){}
            hideModal();
            const categoryMap = { 'Esportes':'Sports', 'Ci√™ncias':'Science', 'Artes':'Art', 'Mundo':'Movies', 'Sociedade':'History', 'Aleat√≥rio': null };
            const mapped = categoryMap[category] || category;
            const cats = Object.keys(questions);
            const chosen = cats.includes(mapped) ? mapped : (cats[Math.floor(Math.random()*cats.length)]);
            if(localPlayerId === currentPlayer){
              try{ localStorage.setItem('sync_roleta', JSON.stringify({ category: chosen, wheelPoints: pointsValue, by: currentPlayer, at: Date.now() })); }catch(e){}
            }
            showCardSelection(chosen, pointsValue);
            try{ const btn = document.getElementById('openRoletaBtn'); if(btn) btn.disabled = true; }catch(e){}
          }, 3000);
        }
      }catch(err){ console.warn('message handler error', err); }
    });

    let autoPickTimer = null;

    function showCardSelection(category, wheelPoints){

      try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
      try{ setPowerTrayVisible(false); }catch(e){}

      try{ const badge = document.getElementById('cat-badge'); if(badge){ badge.style.display='none'; badge.textContent=''; } }catch(e){}
      const cardsDiv = document.getElementById('cards');
      cardsDiv.innerHTML = '';
      cardsDiv.style.pointerEvents = 'auto';
      try{ cardsDiv.style.display = 'block'; }catch(e){}

      const sideLeft = document.createElement('div');
      sideLeft.className = 'cards-side left';
      const sideRight = document.createElement('div');
      sideRight.className = 'cards-side right';
      const stackLeft = document.createElement('div');
      stackLeft.className = 'cards-stack';
      const stackRight = document.createElement('div');
      stackRight.className = 'cards-stack';
      const leftCol = document.createElement('div');
      leftCol.className = 'cards-col';
      const leftCol2 = document.createElement('div');
      leftCol2.className = 'cards-col';
      const rightCol = document.createElement('div');
      rightCol.className = 'cards-col';
      const rightCol2 = document.createElement('div');
      rightCol2.className = 'cards-col';
      stackLeft.appendChild(leftCol);
      stackLeft.appendChild(leftCol2);
      stackRight.appendChild(rightCol);
      stackRight.appendChild(rightCol2);
      sideLeft.appendChild(stackLeft);
      sideRight.appendChild(stackRight);
      cardsDiv.appendChild(sideLeft);
      cardsDiv.appendChild(sideRight);

      try{
        leftCol2.style.marginTop = '28px';
        rightCol.style.marginTop = '28px';
      }catch(e){}


      try{ window._shuffleClicks = 0; window._shuffleQAt = Date.now(); }catch(e){}

      try{
        const titleEl = document.getElementById('category');
        if(titleEl){
          titleEl.classList.add('centered-title');

          const arrow = (currentPlayer === 1) ? '‚¨Ö' : '‚û°';
          titleEl.innerText = `Jogador ${currentPlayer}, escolha uma carta  ${arrow}`;
          titleEl.style.fontSize = '28px';
          titleEl.style.fontWeight = '800';
          titleEl.style.letterSpacing = '0.5px';
          titleEl.style.textShadow = '0 0 10px rgba(255,215,0,0.4)';
        }
      }catch(e){}

      let cardChosen = false;


      const myUsed = Array.isArray(usedCardsCache[currentPlayer]) ? usedCardsCache[currentPlayer] : [];
      const values = [1,2,3,4,5];
      const availableValues = values.filter(v => !myUsed.includes(v));
      const cardEls = [];


      for(let i=0;i<values.length;i++){
        const makeCard = (val, forPlayer)=>{
          const c = document.createElement('div');
          c.className = 'card';
          c.style.position = 'relative';
          c.dataset.value = String(val);
          c.textContent = String(val);
          c.style.fontWeight = '800';
          c.style.color = '#FFFFFF';
          const usedArr = Array.isArray(usedCardsCache[forPlayer]) ? usedCardsCache[forPlayer] : [];
          if(usedArr.includes(val)) c.classList.add('card-used');
          if(usedArr.includes(val)) c.style.color = '#000';
          return c;
        };
        const val = values[i];
        const cardLeft = makeCard(val,1);
        const cardRight = makeCard(val,2);

        if(i < 3){ leftCol.appendChild(cardLeft); }
        else { leftCol2.appendChild(cardLeft); }

        if(i < 3){ rightCol2.appendChild(cardRight); }
        else { rightCol.appendChild(cardRight); }

        const interactiveCard = (localPlayerId === 2) ? cardRight : cardLeft;
        cardEls.push(interactiveCard);
      }


      if(availableValues.length === 0){
        try{
          const payload = { category: category, pointsValue: wheelPoints || 1, by: currentPlayer, at: Date.now(), noCardAvailable: true };
          localStorage.setItem('sync_card', JSON.stringify(payload));
        }catch(e){}
        setTimeout(()=> chooseCard(wheelPoints || 1, category), 300);
        return;
      }


      cardsDiv.addEventListener('click', function onCardsClick(e){
        const card = e.target.closest('.card');
        if(!card) return;
        if (localPlayerId !== currentPlayer) return;

        try{
          const inLeftSide = !!card.closest('.cards-side.left');
          if(currentPlayer === 1 && !inLeftSide) return;
          if(currentPlayer === 2 && inLeftSide) return;
        }catch(err){}
        if(card.classList.contains('card-used')) return;
        if(cardChosen) return;
        cardChosen = true;
        try{ if(autoPickTimer){ clearTimeout(autoPickTimer); autoPickTimer = null; } }catch(e){}

        const cardValue = parseInt(card.dataset.value,10);
        const pts = cardValue || wheelPoints || 1;
        playSFX('carta');

        try{ card.classList.add('card-used'); card.style.color = '#000'; }catch(e){}

        try{
          const arr = Array.isArray(usedCardsCache[currentPlayer]) ? usedCardsCache[currentPlayer] : [];
          if(!arr.includes(cardValue)) arr.push(cardValue);
          usedCardsCache[currentPlayer] = arr;
          localStorage.setItem('used_cards_'+currentPlayer, JSON.stringify(arr));
        }catch(e){}
        try{ localStorage.setItem('sync_card', JSON.stringify({ category: category, pointsValue: pts, by: currentPlayer, at: Date.now(), cardValue: cardValue })); }catch(e){}

        cardsDiv.style.pointerEvents = 'none';
        cardsDiv.removeEventListener('click', onCardsClick);
        chooseCard(pts, category);
      });


      if(localPlayerId === currentPlayer){
        autoPickTimer = setTimeout(()=>{
          try{
            if(cardChosen) return;
            const available = cardEls.filter(el => !el.classList.contains('card-used'));
            if(available.length === 0){

              const pts = wheelPoints || 1;
              try{ localStorage.setItem('sync_card', JSON.stringify({ category: category, pointsValue: pts, by: currentPlayer, at: Date.now(), noCardAvailable: true })); }catch(e){}
              chooseCard(pts, category);
              return;
            }
            const picked = available[Math.floor(Math.random()*available.length)];
            cardChosen = true;
            const cardValue = parseInt(picked.dataset.value,10);
            const pts = cardValue || wheelPoints || 1;
            playSFX('carta');
            try{
              const arr = Array.isArray(usedCardsCache[currentPlayer]) ? usedCardsCache[currentPlayer] : [];
              if(!arr.includes(cardValue)) arr.push(cardValue);
              usedCardsCache[currentPlayer] = arr;
              localStorage.setItem('used_cards_'+currentPlayer, JSON.stringify(arr));
            }catch(e){}

            try{ picked.classList.add('card-used'); picked.style.color = '#000'; }catch(e){}
            try{ localStorage.setItem('sync_card', JSON.stringify({ category: category, pointsValue: pts, by: currentPlayer, at: Date.now(), cardValue: cardValue })); }catch(e){}

            cardsDiv.style.pointerEvents = 'none';
            chooseCard(pts, category);
          }catch(e){}
        }, 5000);
      }
    }


    try{ window.showCardSelection = showCardSelection; }catch(e){}


    function ensureRoletaOpenIfIdle(){
      try{
        const qa = document.getElementById('question-area');
        const cards = document.getElementById('cards');
        const isQ = qa && window.getComputedStyle(qa).display !== 'none';
        const isC = cards && window.getComputedStyle(cards).display !== 'none';
        if(!isQ && !isC){

          try{ iframe.src = 'roleta.html?_=' + Date.now(); }catch(e){}

          showModal();

          const sendSetup = ()=>{
            try{ iframe.contentWindow.postMessage({ type:'setSpinEnabled', enabled: (localPlayerId === currentPlayer) }, '*'); }catch(e){}
            try{ iframe.contentWindow.postMessage({ type:'resetWheel' }, '*'); }catch(e){}
          };
          try{
            if(!iframe.contentWindow || iframe.contentDocument.readyState !== 'complete'){
              iframe.addEventListener('load', function onld(){ try{ sendSetup(); }catch(e){} iframe.removeEventListener('load', onld); });
            } else {
              sendSetup();
            }
          }catch(e){}
        }
      }catch(e){}
    }
    try{ window.ensureRoletaOpenIfIdle = ensureRoletaOpenIfIdle; }catch(e){}


    function setupRoletaForTurn(){
      try{
        const iframe = document.getElementById('roletaIframe');
        if(!iframe) return;

        try{
          const qa = document.getElementById('question-area');
          const ro = document.getElementById('roleta-area');
          const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
          if(ro && !isQuestionVisible){ ro.style.display = 'flex'; }
        }catch(e){}


        try{ iframe.src = 'roleta.html?_=' + Date.now(); }catch(e){}

        const sendSetup = ()=>{
          try{ iframe.contentWindow.postMessage({ type:'setSpinEnabled', enabled: (localPlayerId === currentPlayer) }, '*'); }catch(e){}
          try{ iframe.contentWindow.postMessage({ type:'resetWheel' }, '*'); }catch(e){}

          try{
            const overlay = document.getElementById('roletaOverlay');
            if(overlay) overlay.style.display = (localPlayerId === currentPlayer) ? 'none' : 'flex';
            if(iframe){ if(localPlayerId !== currentPlayer) iframe.classList.add('dim'); else iframe.classList.remove('dim'); }
          }catch(e){}
        };
        if(!iframe.contentWindow || (iframe.contentDocument && iframe.contentDocument.readyState !== 'complete')){
          iframe.addEventListener('load', function onld(){ try{ sendSetup(); }catch(e){} iframe.removeEventListener('load', onld); });
        } else {
          sendSetup();
        }
      }catch(e){}
    }
    try{ window.setupRoletaForTurn = setupRoletaForTurn; }catch(e){}
  })();

  function hydrateFromStorage(){
    try{
      const parse = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)||'{}'); }catch(e){ return null; } };
      const q = parse('sync_question');
      const a = parse('sync_answer');
      const r = parse('sync_roleta');
      const s = parse('sync_roleta_spin');
      const m = parse('matchResult');
      const uc1 = (()=>{ try{ return JSON.parse(localStorage.getItem('used_cards_1')||'[]'); }catch(e){ return []; } })();
      const uc2 = (()=>{ try{ return JSON.parse(localStorage.getItem('used_cards_2')||'[]'); }catch(e){ return []; } })();
      usedCardsCache = { 1: Array.isArray(uc1) ? uc1 : [], 2: Array.isArray(uc2) ? uc2 : [] };
      const getAt = (o)=> (o && typeof o.at === 'number') ? o.at : 0;
      const latest = [q,a,r,s,m].filter(Boolean).sort((x,y)=> getAt(y)-getAt(x))[0] || null;

      if(a && a.newPoints){
        points[1] = a.newPoints[1]||0; points[2] = a.newPoints[2]||0;
        const p1El = document.getElementById('player1-points'); if(p1El) p1El.textContent = `${points[1]} pts`;
        const p2El = document.getElementById('player2-points'); if(p2El) p2El.textContent = `${points[2]} pts`;
      }

      if(latest === m && m && m.winnerId){
        const winner = { id: m.winnerId, name: document.getElementById(`player${m.winnerId}-name`).textContent, pts: m.pts };
        if(localPlayerId === m.winnerId){
          showFinalWinner(winner);
        } else if(localPlayerId === (m.winnerId === 1 ? 2 : 1)){
          showLoserModal(m);
        }
        return;
      }

      if(latest === q && q && q.category){
        currentPlayer = q.by || currentPlayer;
        renderQuestionPayload(q);
        updateTurnUI();
        try{ setPowerTrayVisible(true); }catch(e){}
        try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 50); }catch(e){}
        try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 200); }catch(e){}
        return;
      }

      if(latest === r && r && r.category){
        currentPlayer = r.by || currentPlayer;
        try{ setPowerTrayVisible(false); }catch(e){}
        showCardSelection(r.category, r.wheelPoints || 1);
        updateTurnUI();
        return;
      }

      if(latest === s && s && typeof s.index === 'number'){
        currentPlayer = s.by || currentPlayer;
        try{
          try{ window._spinInProgress = true; }catch(e){}
          try{ if(typeof window.ensureRoletaOpenIfIdle === 'function') window.ensureRoletaOpenIfIdle(); }catch(e){}
          const iframe = document.getElementById('roletaIframe');
          try{
            const overlay = document.getElementById('roletaOverlay');
            if(overlay) overlay.style.display = (localPlayerId === currentPlayer) ? 'none' : 'flex';
            if(iframe){ if(localPlayerId !== currentPlayer) iframe.classList.add('dim'); else iframe.classList.remove('dim'); }
          }catch(e){}
          try{ iframe.contentWindow.postMessage({ type:'spinNow', index: s.index, turns: s.turns, duration: s.duration }, '*'); }catch(e){}
        }catch(e){}
        updateTurnUI();
        try{ setPowerTrayVisible(false); }catch(e){}
        return;
      }

      if(a && a.nextPlayer){
        currentPlayer = a.nextPlayer;
        updateTurnUI();
        return;
      }

      currentPlayer = 1;
      updateTurnUI();
      try{ if(typeof window.ensureRoletaOpenIfIdle === 'function') window.ensureRoletaOpenIfIdle(); }catch(e){}
    }catch(e){ console.warn('hydrateFromStorage error', e); }
  }

  try{
    window.addEventListener('storage', (ev) => {
      if(!ev) return;
      if(ev.key === 'matchResult'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(data && data.winnerId && data.loserId){
            if(localPlayerId === data.loserId){
              showLoserModal(data);
            }
          }
        }catch(e){}
      }
      if(ev.key === 'rematchNow'){
        try{ stopConfettiLoop(); }catch(e){}
        try{ stopFireworksLoop(); }catch(e){}
        try{ clearRematchTimeout(); }catch(e){}
        try{ localStorage.removeItem('used_cards_1'); localStorage.removeItem('used_cards_2'); localStorage.removeItem('used_cards'); }catch(e){}
        location.reload();
      }
      if(ev.key === 'rematchRequest'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || !data.from) return;
          if(localPlayerId === data.from){
            const oppId = (data.to) ? data.to : (localPlayerId === 1 ? 2 : 1);
            showRematchWaitingModal(oppId);
            try{ startRematchTimeout(); }catch(e){}
          } else if(localPlayerId === (data.to || (localPlayerId === 1 ? 2 : 1))){
            showRematchPromptModal(data.from);
            try{ startRematchTimeout(); }catch(e){}
          }
        }catch(e){}
      }
      if(ev.key === 'rematchResponse'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data) return;
          hideRematchModals();
          try{ clearRematchTimeout(); }catch(e){}
          if(data.accepted){
            try{ localStorage.setItem('rematchNow', String(Date.now())); }catch(e){}
          } else {
            try{ localStorage.setItem('goLobbyNow', String(Date.now())); }catch(e){}
          }
        }catch(e){}
      }
      if(ev.key === 'goLobbyNow'){
        try{ stopConfettiLoop(); }catch(e){}
        try{ stopFireworksLoop(); }catch(e){}
        try{ clearRematchTimeout(); }catch(e){}
        try{ localStorage.removeItem('used_cards_1'); localStorage.removeItem('used_cards_2'); localStorage.removeItem('used_cards'); }catch(e){}
        location.href = 'players.html';
      }
      if(ev.key === 'sync_roleta_spin'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.index !== 'number') return;
          try{ window._spinInProgress = true; }catch(e){}
          try{ if(typeof window.ensureRoletaOpenIfIdle === 'function') window.ensureRoletaOpenIfIdle(); }catch(e){}
          try{ const cd = document.getElementById('cards'); if(cd) cd.style.display = 'none'; }catch(e){}
          const iframe = document.getElementById('roletaIframe');
          try{
            const overlay = document.getElementById('roletaOverlay');
            if(overlay) overlay.style.display = (localPlayerId === currentPlayer) ? 'none' : 'flex';
            if(iframe){ if(localPlayerId !== currentPlayer) iframe.classList.add('dim'); }
          }catch(e){}
          const postSpin = ()=>{ try{ iframe.contentWindow.postMessage({ type:'spinNow', index: data.index, turns: data.turns, duration: data.duration }, '*'); }catch(e){} };
          try{
            if(!iframe.contentWindow || iframe.contentDocument.readyState !== 'complete'){
              iframe.addEventListener('load', function onld(){ try{ postSpin(); }catch(e){} iframe.removeEventListener('load', onld); });
            } else {
              postSpin();
            }
          }catch(e){}
        }catch(e){}
      }
      if(ev.key === 'sync_roleta'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || !data.category) return;
          try{ window._spinInProgress = false; }catch(e){}
          setTimeout(()=>{
            try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
            try{ const cd = document.getElementById('cards'); if(cd) cd.style.display = 'block'; }catch(e){}
            try{ setPowerTrayVisible(false); }catch(e){}
            showCardSelection(data.category, data.wheelPoints || 1);
          }, 3000);
        }catch(e){}
      }
      if(ev.key === 'sync_card'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || !data.category) return;
          try{ const cd = document.getElementById('cards'); if(cd) cd.style.pointerEvents = 'none'; }catch(e){}
          try{
            const cardValue = (typeof data.cardValue === 'number') ? data.cardValue : (typeof data.pointsValue === 'number' ? data.pointsValue : null);
            const by = data.by;
            if(by === 1 || by === 2){
              if(cardValue != null && cardValue >= 1 && cardValue <= 5 && !data.noCardAvailable){
                const arr = Array.isArray(usedCardsCache[by]) ? usedCardsCache[by] : [];
                if(!arr.includes(cardValue)){
                  arr.push(cardValue);
                  usedCardsCache[by] = arr;
                  localStorage.setItem('used_cards_'+by, JSON.stringify(arr));
                }
                const root = document.getElementById('cards');
                if(root){
                  const sideSel = (by === 1) ? '.cards-side.left' : '.cards-side.right';
                  const sideRoot = root.querySelector(sideSel);
                  if(sideRoot){
                    const el = sideRoot.querySelector(`.card[data-value="${cardValue}"]`);
                    if(el) el.classList.add('card-used');
                    if(el) el.style.color = '#000';
                  }
                }
              }
            }
          }catch(e){}
        }catch(e){}
      }
      if(ev.key === 'sync_question'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || !data.category) return;
          try{ currentPlayer = data.by || currentPlayer; }catch(e){}
          renderQuestionPayload(data);
          updateTurnUI();
          try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 50); }catch(e){}
          try{ setTimeout(()=>{ try{ setPowerTrayVisible(true); }catch(e){} }, 200); }catch(e){}
        }catch(e){}
      }
      if(ev.key === 'sync_answer'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data) return;
          try{
            const ansDiv = document.getElementById('answers');
            if(ansDiv){
              const btns = Array.from(ansDiv.querySelectorAll('button'));
              btns.forEach(b=> b.disabled = true);
              if(data.selectedIndex != null){
                const selBtn = ansDiv.querySelector(`button[data-idx="${data.selectedIndex}"]`);
                if(selBtn){ selBtn.classList.add(data.correct ? 'ans-correct' : 'ans-wrong'); }
              }
              if(!data.correct && data.correctIndex != null){
                const corBtn = ansDiv.querySelector(`button[data-idx="${data.correctIndex}"]`);
                if(corBtn){ corBtn.classList.add('ans-correct'); }
              }
              if(data.selectedIndex == null && data.correctIndex != null){
                const corBtn = ansDiv.querySelector(`button[data-idx="${data.correctIndex}"]`);
                if(corBtn){ corBtn.classList.add('ans-correct'); }
              }
            }
          }catch(e){}
          setTimeout(()=>{
            try{
              if(data.newPoints){
                points[1] = data.newPoints[1]||0; points[2] = data.newPoints[2]||0;
                const p1El = document.getElementById('player1-points'); if(p1El) p1El.textContent = `${points[1]} pts`;
                const p2El = document.getElementById('player2-points'); if(p2El) p2El.textContent = `${points[2]} pts`;
              }
              if(checkForWinner()) return;
              try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
              try{ document.getElementById('question-area').style.display = 'none'; }catch(e){}
              try{ const cd = document.getElementById('cards'); if(cd){ cd.style.display = 'none'; cd.style.pointerEvents = 'none'; } }catch(e){}
              try{ document.getElementById('category').innerText = ''; }catch(e){}
              try{ document.getElementById('waiting-screen').style.display = 'none'; }catch(e){}
              try{ setPowerTrayVisible(false); }catch(e){}
              currentPlayer = data.nextPlayer || (currentPlayer===1?2:1);
              try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
              updateTurnUI();
              if(typeof window.ensureRoletaOpenIfIdle === 'function') window.ensureRoletaOpenIfIdle();
              if(typeof window.setupRoletaForTurn === 'function') window.setupRoletaForTurn();
            }catch(e){}
          }, 2000);
        }catch(e){}
      }
      if(ev.key === 'power_freeze'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.target !== 'number') return;
          if(currentPlayer === data.target){
            const ansDiv = document.getElementById('answers');
            if(ansDiv){
              const btns = Array.from(ansDiv.querySelectorAll('button'));
              btns.forEach(b=> {
                b.disabled = true;
                b.classList.add("congelado");   // <-- ADICIONADO AQUI
              });
              setTimeout(()=>{
                try{
                  const qa = document.getElementById('question-area');
                  const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
                  if(isQuestionVisible && currentPlayer === data.target){
                    btns.forEach(b=> {
                      b.disabled = false;
                      b.classList.remove("congelado");  // <-- ADICIONADO AQUI
                    });
                  }
                }catch(e){}
              }, data.durationMs || 5000);
            }
          }
        }catch(e){}
      }
      if(ev.key === 'power_shuffle'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.target !== 'number') return;
          const ctx = window._currentQuestionCtx || {};
          if(currentPlayer === data.target && ctx && ctx.at && ctx.at === data.qAt){
            window._shuffleClicks = (window._shuffleClicks||0) + 1;
            if(window._shuffleClicks > 3) return;
            const ansDiv = document.getElementById('answers');
            if(ansDiv){
              const btns = Array.from(ansDiv.querySelectorAll('button'));
              if(btns.length > 1){
                const correctIndex = typeof ctx.correct === 'number' ? ctx.correct : null;
                if(correctIndex != null && correctIndex >=0 && correctIndex < btns.length){

                  let newPos;
                  do{ newPos = Math.floor(Math.random()*btns.length); }while(newPos === correctIndex);
                  if(newPos !== correctIndex){
                    const tmp = btns[newPos].innerText;
                    btns[newPos].innerText = btns[correctIndex].innerText;
                    btns[correctIndex].innerText = tmp;
                    ctx.correct = newPos;
                    try{ window._currentQuestionCtx.correct = newPos; }catch(e){}
                  }
                }
              }
            }
          }
        }catch(e){}
      }
      if(ev.key === 'power_runaway'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.target !== 'number') return;
          const ctx = window._currentQuestionCtx || {};
          if(currentPlayer !== data.target || !ctx || !ctx.at || ctx.at !== data.qAt) return;
          const ansDiv = document.getElementById('answers');
          if(!ansDiv) return;
          let remaining = Number(data.clicks)||4;
          const parent = ansDiv;
          const originalStyles = new Map();
          parent.style.position = parent.style.position || 'relative';
          const btns = Array.from(parent.querySelectorAll('button'));
          btns.forEach(b=>{
            originalStyles.set(b, { position: b.style.position||'', top: b.style.top||'', left: b.style.left||'', transform: b.style.transform||'' });
          });
          function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
          function scatter(){
            const rect = parent.getBoundingClientRect();
            btns.forEach(b=>{
              const br = b.getBoundingClientRect();
              const w = br.width || 100, h = br.height || 40;
              const maxLeft = Math.max(0, rect.width - w);
              const maxTop = Math.max(0, rect.height - h);
              const left = clamp(Math.floor(Math.random()*maxLeft), 0, maxLeft);
              const top = clamp(Math.floor(Math.random()*maxTop), 0, maxTop);
              b.style.position = 'absolute';
              b.style.left = left+'px';
              b.style.top = top+'px';
              b.style.transform = 'translate(0,0)';
            });
          }
          function restore(){
            btns.forEach(b=>{
              const st = originalStyles.get(b)||{};
              b.style.position = st.position; b.style.top = st.top; b.style.left = st.left; b.style.transform = st.transform;
            });
            parent.removeEventListener('click', handler, true);
            try{ window._runawayActive = false; }catch(e){}
          }
          function handler(ev){
            try{
              const targetBtn = ev.target && ev.target.closest && ev.target.closest('button');
              if(!targetBtn) return;
              ev.stopImmediatePropagation(); ev.stopPropagation(); ev.preventDefault();
              remaining -= 1;
              scatter();
              if(remaining <= 0){ restore(); }
            }catch(e){}
          }
          try{ window._runawayActive = true; }catch(e){}
          scatter();
          parent.addEventListener('click', handler, true);
        }catch(e){}
      }
      if(ev.key === 'power_jumpscare'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.target !== 'number') return;
          const ctx = window._currentQuestionCtx || {};
          if(currentPlayer !== data.target || !ctx || !ctx.at || ctx.at !== data.qAt) return;
          const ansDiv = document.getElementById('answers'); if(!ansDiv) return;
          const deadline = Date.now() + (data.durationMs || 5000);
          function ensureShakeCSS(){
            if(document.getElementById('scare-shake-style')) return;
            const st = document.createElement('style'); st.id='scare-shake-style';
            st.textContent = '@keyframes scareShake{0%{transform:translate(0,0)}20%{transform:translate(-6px,4px)}40%{transform:translate(6px,-4px)}60%{transform:translate(-4px,6px)}80%{transform:translate(4px,-6px)}100%{transform:translate(0,0)}} .shake-anim{animation:scareShake 120ms linear infinite}';
            document.head.appendChild(st);
          }
          ensureShakeCSS();
          const jumpImgs = ['sons/audios/jump1.jpg','sons/audios/jump2.jpg','sons/audios/jump3.jpg'];
          const jumpSounds = ['sons/audios/audios/jumpscare 1.m4a','sons/audios/audios/jumpscare 2.m4a','sons/audios/audios/jumpscare 3.m4a'];
          function showJump(){
            const old = document.getElementById('jumpscareOverlay'); if(old && old.parentNode) old.parentNode.removeChild(old);
            const ov = document.createElement('div'); ov.id='jumpscareOverlay';
            ov.style.position='fixed'; ov.style.inset='0'; ov.style.zIndex=10020; ov.style.display='flex'; ov.style.alignItems='center'; ov.style.justifyContent='center'; ov.style.background='rgba(0,0,0,0.2)'; ov.style.pointerEvents='none';
            const img = document.createElement('img'); img.src = jumpImgs[Math.floor(Math.random()*jumpImgs.length)]; img.alt=''; img.style.maxWidth='90%'; img.style.maxHeight='90%'; img.style.borderRadius='12px'; img.style.boxShadow='0 10px 40px rgba(0,0,0,0.6)';
            ov.appendChild(img); document.body.appendChild(ov);
            document.body.classList.add('shake-anim');
            const audio = new Audio(jumpSounds[Math.floor(Math.random()*jumpSounds.length)]); audio.volume = 1.0; audio.play().catch(()=>{});
            setTimeout(()=>{ try{ document.body.classList.remove('shake-anim'); if(ov && ov.parentNode) ov.parentNode.removeChild(ov); }catch(e){} }, (data.durationMs||5000));
          }
          try{ showJump(); }catch(e){}
        }catch(e){}
      }
      if(ev.key === 'power_xmask'){
        try{
          const data = JSON.parse(ev.newValue||'{}');
          if(!data || typeof data.target !== 'number') return;
          const ctx = window._currentQuestionCtx || {};
          if(currentPlayer !== data.target || !ctx || !ctx.at || ctx.at !== data.qAt) return;
          const qEl = document.getElementById('question');
          const ansDiv = document.getElementById('answers'); if(!qEl || !ansDiv) return;
          const btns = Array.from(ansDiv.querySelectorAll('button'));
          const original = { q: qEl.textContent, a: btns.map(b=>b.textContent) };
          function maskText(s){ if(!s) return s; return s.replace(/[AEIOU√Å√â√ç√ì√ö√Ç√ä√é√î√õ√É√ïaeiou√°√©√≠√≥√∫√¢√™√Æ√¥√ª√£√µ]/g,'X').replace(/[02468]/g,'X'); }
          qEl.textContent = maskText(original.q);
          btns.forEach((b,i)=>{ b.textContent = maskText(original.a[i]||''); });
          setTimeout(()=>{
            try{ qEl.textContent = original.q; btns.forEach((b,i)=>{ b.textContent = original.a[i]||''; }); }catch(e){}
          }, data.durationMs || 5000);
        }catch(e){}
      }
    });
  }catch(e){ }

  function chooseCard(pointsValue, category) {
    try{ document.getElementById('openRoletaBtn').disabled = true; }catch(e){}
    try{ const catEl = document.getElementById('category'); if(catEl) { catEl.classList.remove('centered-title'); catEl.innerText = ''; } }catch(e){}
    try{ const badge = document.getElementById('cat-badge'); if(badge){ badge.style.display='none'; badge.textContent=''; } }catch(e){}
    try{ const ws = document.getElementById('waiting-screen'); if(ws) ws.style.display = 'none'; }catch(e){}

    const qData = questions[category][0];
    const payload = {
      category,
      question: qData.question,
      answers: qData.answers,
      correct: qData.correct,
      pointsValue: pointsValue,
      by: currentPlayer,
      at: Date.now()
    };

    try{ localStorage.setItem('sync_question', JSON.stringify(payload)); }catch(e){}
    renderQuestionPayload(payload);
  }

  function startTimer() {
    clearInterval(timer);
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
    timeLeft = 15;
    updateTimer();
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if(timeLeft === 5){ playSFX('cronometro'); }
      if (timeLeft <= 0) {
        clearInterval(timer);
        try{
          const ctx = window._currentQuestionCtx || {};
          answerQuestion(false, ctx.pointsValue||0, ctx.category||'', null, typeof ctx.correct==='number'?ctx.correct:null);
        }catch(e){ answerQuestion(false); }
        stopSFX('cronometro');
      }
    }, 1000);
  }

  function startTimerRemaining(remaining) {
    clearInterval(timer);
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
    timeLeft = Math.max(0, Math.floor(remaining || 0));
    updateTimer();
    if (timeLeft <= 0) {
      try{
        const ctx = window._currentQuestionCtx || {};
        answerQuestion(false, ctx.pointsValue||0, ctx.category||'', null, typeof ctx.correct==='number'?ctx.correct:null);
      }catch(e){ answerQuestion(false); }
      return;
    }
    try{ setPowerTrayVisible(true); }catch(e){}
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if(timeLeft === 5){ playSFX('cronometro'); }
      if (timeLeft <= 0) {
        clearInterval(timer);
        try{
          const ctx = window._currentQuestionCtx || {};
          answerQuestion(false, ctx.pointsValue||0, ctx.category||'', null, typeof ctx.correct==='number'?ctx.correct:null);
        }catch(e){ answerQuestion(false); }
        stopSFX('cronometro');
      }
    }, 1000);
  }

  function startSpectatorTimerRemaining(remaining){
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); } }catch(e){}
    try{ if(timer){ clearInterval(timer); } }catch(e){}
    timeLeft = Math.max(0, Math.floor(remaining || 0));
    updateTimer();
    if(timeLeft <= 0){ return; }
    spectatorTimer = setInterval(()=>{
      timeLeft--;
      updateTimer();
      if(timeLeft <= 0){
        try{ clearInterval(spectatorTimer); spectatorTimer = null; }catch(e){}
      }
    }, 1000);
  }

  function updateTimer() {
    document.getElementById("timer-text").innerText = timeLeft;
    const circle = document.getElementById("timer-circle");
    const offset = (15 - timeLeft) * (170 / 15);
    circle.style.strokeDashoffset = offset;
    circle.style.stroke = timeLeft > 5 ? "#00FF00" : "#FF0000";
  }

  function answerQuestion(isCorrect, pointsValue = 0, category = "", selectedIndex = null, correctIndex = null) {
    clearInterval(timer);
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}

    try{
      const ansDiv = document.getElementById('answers');
      if(ansDiv){
        const btns = Array.from(ansDiv.querySelectorAll('button'));
        btns.forEach(b=>{ b.disabled = true; });
        if(selectedIndex != null){
          const selBtn = ansDiv.querySelector(`button[data-idx="${selectedIndex}"]`);
          if(selBtn){ selBtn.classList.add(isCorrect ? 'ans-correct' : 'ans-wrong'); }
        }
        if(!isCorrect && correctIndex != null){
          const corBtn = ansDiv.querySelector(`button[data-idx="${correctIndex}"]`);
          if(corBtn){ corBtn.classList.add('ans-correct'); }
        }
        if(selectedIndex == null && correctIndex != null){
          const corBtn = ansDiv.querySelector(`button[data-idx="${correctIndex}"]`);
          if(corBtn){ corBtn.classList.add('ans-correct'); }
        }
      }
      playSFX(isCorrect ? 'resposta_correta' : 'resposta_errada');
      stopSFX('cronometro');
    }catch(e){}

    const next = (currentPlayer === 1) ? 2 : 1;
    const newPoints = { 1: points[1], 2: points[2] };
    try{
      const ctx = window._currentQuestionCtx || {};
      let awardTo = null;
      if(isCorrect){
        // resposta correta: quem respondeu leva (se foi roubo, o ladr√£o pontua)
        awardTo = currentPlayer;
      } else {
        // resposta errada ou tempo: se houve roubo, pontos voltam para o original
        if(ctx && ctx.stolenFrom && currentPlayer === ctx.stolenBy){
          awardTo = ctx.stolenFrom;
        }
      }
      if(awardTo){ newPoints[awardTo] += pointsValue; }
    }catch(e){ if(isCorrect){ newPoints[currentPlayer] += pointsValue; } }

    try{
      const ctx = window._currentQuestionCtx || {};
      localStorage.setItem('sync_answer', JSON.stringify({ by: currentPlayer, correct: isCorrect, pointsValue, category, newPoints, nextPlayer: next, at: Date.now(), selectedIndex, correctIndex, stolenFrom: ctx.stolenFrom, stolenBy: ctx.stolenBy }));
    }catch(e){}

    setTimeout(()=>{
      points = newPoints;
      try{ document.getElementById(`player1-points`).innerText = `${points[1]} pts`; }catch(e){}
      try{ document.getElementById(`player2-points`).innerText = `${points[2]} pts`; }catch(e){}

      roundCount += 1;
      if(checkForWinner()) return;
      finalizeIfRoundLimitOrWinner();
      if(roundCount >= 5) return;

      try{ document.getElementById("question-area").style.display = "none"; }catch(e){}
      try{ const cd = document.getElementById('cards'); if(cd){ cd.style.display = 'none'; cd.style.pointerEvents = 'none'; } }catch(e){}
      try{ document.getElementById("category").innerText = ""; }catch(e){}
      try{ const badge = document.getElementById('cat-badge'); if(badge){ badge.style.display='none'; badge.textContent=''; } }catch(e){}
      try{ setPowerTrayVisible(false); }catch(e){}

      currentPlayer = next;
      try{ const ro = document.getElementById('roleta-area'); if(ro) ro.style.display = 'none'; }catch(e){}
      try{
        updateTurnUI();
        if(typeof window.ensureRoletaOpenIfIdle === 'function') window.ensureRoletaOpenIfIdle();
        if(typeof window.setupRoletaForTurn === 'function') window.setupRoletaForTurn();
      }catch(e){}
    }, 2000);
  }

  function setPowerTrayVisible(show){
    // Mant√©m a barra sempre vis√≠vel durante a partida; apenas oculta em estados finais.
    try{
      const tray = document.getElementById('power-tray');
      if(!tray) return;
      const qa = document.getElementById('question-area');
      const isQuestionVisible = qa ? (window.getComputedStyle(qa).display !== 'none') : false;
      // Se jogo terminou, for√ßa ocultar
      if(window._gameEnded){ tray.style.display = 'none'; return; }
      // Exibir sempre quando solicitado, mesmo que o question ainda n√£o tenha atualizado (evita corrida em p=2)
      tray.style.display = show ? 'flex' : 'none';
      if(!show) return; // se solicitado esconder (fim de jogo), respeita

      tray.classList.remove('center','right','left');
      try{
        let answering = currentPlayer;
        try{ const qraw = localStorage.getItem('sync_question'); const q = JSON.parse(qraw||'{}'); if(q && typeof q.by === 'number') answering = q.by; }catch(e){}
        tray.classList.add('right'); // layout consistente
      }catch(e){ tray.classList.add(localPlayerId === 2 ? 'right' : 'left'); }

      try{
        let answering2 = currentPlayer;
        let stealUsed2 = false;
        try{ const qraw2 = localStorage.getItem('sync_question'); const q2 = JSON.parse(qraw2||'{}'); if(q2 && typeof q2.by === 'number') answering2 = q2.by; stealUsed2 = !!(q2 && q2.stolenFrom); }catch(e){}
        const isOpponentView = (localPlayerId !== answering2);
        const localOnlyButtons = tray.querySelectorAll('.power-btn.local-only');
        localOnlyButtons.forEach(btn=>{
          try{
            const btnPlayer = btn.getAttribute('data-player');
            btn.classList.remove('hidden-remote');
            btn.style.display = '';
            // Ativo somente quando pergunta vis√≠vel e √© vis√£o do oponente
            if(isQuestionVisible && isOpponentView && btnPlayer === String(localPlayerId)){
              btn.disabled = false;
            } else {
              btn.disabled = true;
            }
          }catch(e){}
        });
        try{
          const stealBtn = tray.querySelector('#btn-steal');
          if(stealBtn){
            stealBtn.style.display = '';
            stealBtn.disabled = !(isQuestionVisible && isOpponentView) || stealUsed2;
          }
        }catch(e){}
      }catch(e){}
    }catch(e){}
  }

  function opponentTurn() {
    const categories = Object.keys(questions);
    const category = categories[Math.floor(Math.random() * categories.length)];
    document.getElementById("opponent-category").innerText = `Categoria do oponente: ${englishToPt(category)}`;
    startTimer();

    setTimeout(() => {
      clearInterval(timer);
      const correct = Math.random() > 0.4;
      const earned = Math.floor(Math.random() * 5) + 1;
      if (correct) points[2] += earned;
      document.getElementById("player2-points").innerText = `${points[2]} pts`;
      if(checkForWinner()) return;
      roundCount += 1;
      if(checkForWinner()) return;
      finalizeIfRoundLimitOrWinner();
      if(roundCount >= 5) return;
      document.getElementById("waiting-screen").style.display = "none";
      document.getElementById("opponent-category").innerText = "";
      document.getElementById("roleta-area").style.display = "flex";
      try{ document.getElementById('openRoletaBtn').disabled = false; }catch(e){}
      try{
        setTimeout(() => {
          if (typeof window.openRoletaModal === 'function') window.openRoletaModal();
          else document.getElementById('openRoletaBtn').click();
        }, 800);
      }catch(err){ console.warn('auto-open roleta failed', err); }
    }, 4000);
  }

  function checkForWinner(){
    const winScore = 15;
    if(points[1] >= winScore || points[2] >= winScore){
      const winner = points[1] >= winScore ? {id:1,name:document.getElementById('player1-name').textContent,pts:points[1]} : {id:2,name:document.getElementById('player2-name').textContent,pts:points[2]};
      showFinalWinner(winner);
      return true;
    }
    return false;
  }

  function showFinalWinner(winner){
    clearInterval(timer);
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
    try{ window._gameEnded = true; }catch(e){}
    document.getElementById('roleta-area').style.display = 'none';
    document.getElementById('question-area').style.display = 'none';
    document.getElementById('cards').style.display = 'none';
    document.getElementById('waiting-screen').style.display = 'none';
    try{ setPowerTrayVisible(false); }catch(e){}
    playSFX('vencedor');
    stopSFX('musica_quiz');

    let modal = document.getElementById('finalWinnerModal');
    if(!modal){
      modal = document.createElement('div');
      modal.id = 'finalWinnerModal';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.background = 'rgba(0,0,0,0.65)';
      modal.style.zIndex = 10000;
      modal.innerHTML = `
      <div class="fw-modal-content">
        <img id="fw-icon" class="fw-modal-icon" src="" alt="√çcone do vencedor">
        <div style="text-align:left;min-width:0">
          <h2 style="margin:0 0 8px 0">Fim da Partida</h2>
          <p style="font-size:18px;margin:8px 0">Vencedor: <strong id=fw-name></strong></p>
          <p style="margin:8px 0">Pontos: <strong id=fw-pts></strong></p>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">
            <button id="fw-restart" style="padding:8px 12px;border-radius:8px;border:none;background:#1a4cd7;color:#fff;cursor:pointer">Reiniciar</button>
            <button id="fw-lobby" style="padding:8px 12px;border-radius:8px;border:none;background:#5cb85c;color:#fff;cursor:pointer">Voltar ao Lobby</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(modal);
      try{
        const fwIconEl = document.getElementById('fw-icon');
        const srcEl = document.getElementById(`player${winner.id}-icon`);
        if(fwIconEl && srcEl && srcEl.src) fwIconEl.src = srcEl.src;
      }catch(e){}
      document.getElementById('fw-restart').addEventListener('click', ()=> {
        try{
          const loserId = (winner && winner.id === 1) ? 2 : 1;
          const payload = { from: localPlayerId, to: loserId, at: Date.now() };
          localStorage.setItem('rematchRequest', JSON.stringify(payload));
          showRematchWaitingModal(loserId);
          try{ startRematchTimeout(); }catch(e){}
        }catch(e){}
        try{ stopConfettiLoop(); }catch(e){}; try{ stopFireworksLoop(); }catch(e){};
      });
      document.getElementById('fw-lobby').addEventListener('click', ()=> {
        try{ localStorage.setItem('goLobbyNow', String(Date.now())); }catch(e){}
        try{ stopConfettiLoop(); }catch(e){}; try{ stopFireworksLoop(); }catch(e){};
        location.href = 'players.html';
      });
    }
    document.getElementById('fw-name').textContent = winner.name || `Jogador ${winner.id}`;
    document.getElementById('fw-pts').textContent = winner.pts;
    try{
      const fwIconEl2 = document.getElementById('fw-icon');
      const srcEl2 = document.getElementById(`player${winner.id}-icon`);
      if(fwIconEl2 && srcEl2 && srcEl2.src) fwIconEl2.src = srcEl2.src;
    }catch(e){}
    try{ localStorage.setItem('matchResult', JSON.stringify({ winnerId: winner.id, loserId: winner.id === 1 ? 2 : 1, pts: winner.pts, at: Date.now() })); }catch(e){}
    if(localPlayerId === winner.id){
      try{ startConfettiLoop(); }catch(e){ console.warn('confetti failed', e); }
      try{ startFireworksLoop(); }catch(e){ console.warn('fireworks failed', e); }
    }
  }

  function showLoserModal(result){
    if(document.getElementById('loserModal')) return;
    try{ if(timer){ clearInterval(timer); } }catch(e){}
    try{ if(spectatorTimer){ clearInterval(spectatorTimer); spectatorTimer = null; } }catch(e){}
    try{ window._gameEnded = true; }catch(e){}
    const overlay = document.createElement('div');
    overlay.id = 'loserModal';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.background = 'rgba(0,0,0,0.65)';
    overlay.style.zIndex = 10000;
    const content = document.createElement('div');
    content.className = 'fw-modal-content';
    content.innerHTML = `
    <img class="fw-modal-icon" src="" alt="√çcone do vencedor">
    <div style="text-align:left;min-width:0">
      <h2 style="margin:0 0 8px 0">Fim da Partida</h2>
      <p style="font-size:18px;margin:8px 0">Voc√™ perdeu. Vencedor: <strong id="loser-winner-name"></strong></p>
      <p style="margin:8px 0">Pontos do vencedor: <strong>${(result&&result.pts)||''}</strong></p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">
        <button id="rv-revanche" style="padding:8px 12px;border-radius:8px;border:none;background:#ff9f43;color:#1a1200;font-weight:600;cursor:pointer">Revanche</button>
        <button id="rv-lobby" style="padding:8px 12px;border-radius:8px;border:none;background:#5cb85c;color:#fff;cursor:pointer">Voltar ao Lobby</button>
      </div>
    </div>
  `;
    overlay.appendChild(content);
    document.body.appendChild(overlay);
    try{ setPowerTrayVisible(false); }catch(e){}
    playSFX('derrota');
    stopSFX('musica_quiz');
    try{
      const winnerId = (result && result.winnerId) || 1;
      const nameEl = document.getElementById('loser-winner-name');
      nameEl.textContent = document.getElementById(`player${winnerId}-name`).textContent || `Jogador ${winnerId}`;
      const icon = content.querySelector('.fw-modal-icon');
      const srcEl = document.getElementById(`player${winnerId}-icon`);
      if(icon && srcEl && srcEl.src) icon.src = srcEl.src;
    }catch(e){}
    document.getElementById('rv-revanche').addEventListener('click', ()=>{
      try{
        const toId = (result && result.winnerId) ? result.winnerId : (localPlayerId === 1 ? 2 : 1);
        const payload = { from: localPlayerId, to: toId, at: Date.now() };
        localStorage.setItem('rematchRequest', JSON.stringify(payload));
        showRematchWaitingModal(toId);
        try{ startRematchTimeout(); }catch(e){}
      }catch(e){}
    });
    document.getElementById('rv-lobby').addEventListener('click', ()=>{
      try{ localStorage.setItem('goLobbyNow', String(Date.now())); }catch(e){}
      try{ stopConfettiLoop(); }catch(e){}
      try{ stopFireworksLoop(); }catch(e){}
      location.href = 'players.html';
    });
  }

  function showRematchWaitingModal(opponentId){
    try{ hideRematchModals(); }catch(e){}
    const overlay = document.createElement('div');
    overlay.id = 'rematchWaitingModal';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.background = 'rgba(0,0,0,0.65)';
    overlay.style.zIndex = 10001;
    const content = document.createElement('div');
    content.className = 'fw-modal-content';
    const oppName = (document.getElementById(`player${opponentId}-name`)||{}).textContent || `Jogador ${opponentId}`;
    content.innerHTML = `
    <div style="text-align:center;min-width:0">
      <h3 style="margin:0 0 8px 0">Solicitando revanche...</h3>
      <p style="margin:8px 0">Aguardando <strong>${oppName}</strong> aceitar ou recusar.</p>
      <p style="margin:8px 0;color:#bbb;font-size:14px">Se recusar, ambos voltar√£o ao lobby.</p>
    </div>`;
    overlay.appendChild(content);
    document.body.appendChild(overlay);
  }

  function showRematchPromptModal(requesterId){
    try{ hideRematchModals(); }catch(e){}
    const overlay = document.createElement('div');
    overlay.id = 'rematchPromptModal';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.background = 'rgba(0,0,0,0.65)';
    overlay.style.zIndex = 10001;
    const content = document.createElement('div');
    content.className = 'fw-modal-content';
    const reqName = (document.getElementById(`player${requesterId}-name`)||{}).textContent || `Jogador ${requesterId}`;
    content.innerHTML = `
    <div style="text-align:center;min-width:0">
      <h3 style="margin:0 0 8px 0">Revanche?</h3>
      <p style="margin:8px 0"><strong>${reqName}</strong> solicitou uma revanche.</p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button id="rm-accept" style="padding:8px 12px;border-radius:8px;border:none;background:#1a4cd7;color:#fff;cursor:pointer">Aceitar</button>
        <button id="rm-decline" style="padding:8px 12px;border-radius:8px;border:none;background:#ff6b6b;color:#fff;cursor:pointer">Recusar</button>
      </div>
    </div>`;
    overlay.appendChild(content);
    document.body.appendChild(overlay);

    document.getElementById('rm-accept').addEventListener('click', ()=>{
      try{
        localStorage.setItem('rematchResponse', JSON.stringify({ accepted:true, by: localPlayerId, at: Date.now() }));
        localStorage.setItem('rematchNow', String(Date.now()));
      }catch(e){}
    });
    document.getElementById('rm-decline').addEventListener('click', ()=>{
      try{
        localStorage.setItem('rematchResponse', JSON.stringify({ accepted:false, by: localPlayerId, at: Date.now() }));
        localStorage.setItem('goLobbyNow', String(Date.now()));
      }catch(e){}
    });
  }

  function hideRematchModals(){
    try{ const a = document.getElementById('rematchWaitingModal'); if(a && a.parentNode) a.parentNode.removeChild(a); }catch(e){}
    try{ const b = document.getElementById('rematchPromptModal'); if(b && b.parentNode) b.parentNode.removeChild(b); }catch(e){}
  }

  function clearRematchTimeout(){
    try{ if(window._rematchTimeout){ clearTimeout(window._rematchTimeout); window._rematchTimeout = null; } }catch(e){}
  }
  function startRematchTimeout(){
    try{
      clearRematchTimeout();
      window._rematchTimeout = setTimeout(()=>{
        try{ localStorage.setItem('goLobbyNow', String(Date.now())); }catch(e){}
      }, 7000);
    }catch(e){}
  }

  function randomColor(){
    const palette = ['#FFD700','#FF5E5E','#5EE0FF','#8AFF8A','#C686FF','#FFB86B'];
    return palette[Math.floor(Math.random()*palette.length)];
  }

  function launchConfetti(count = 60){
    const container = document._confettiContainer || document.createElement('div');
    container.className = 'confetti-container';
    for(let i=0;i<count;i++){
      const c = document.createElement('div');
      c.className = 'confetti';
      const left = Math.random()*100;
      c.style.left = left + '%';
      c.style.background = randomColor();
      const dur = (Math.random()*1.6 + 1.2).toFixed(2) + 's';
      c.style.animationDuration = dur;
      c.style.animationDelay = (Math.random()*0.3)+'s';
      c.style.width = (6 + Math.random()*8) + 'px';
      c.style.height = (10 + Math.random()*18) + 'px';
      container.appendChild(c);
      setTimeout(()=>{ try{ if(c && c.parentNode) c.parentNode.removeChild(c); }catch(e){} }, (parseFloat(dur)*1000) + 500);
    }
    if(!document._confettiContainer){ document.body.appendChild(container); setTimeout(()=>{ try{ if(container && container.parentNode) container.parentNode.removeChild(container); }catch(e){} }, 4500); }
  }

  function startConfettiLoop(){
    if(window._confettiInterval) return;
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document._confettiContainer = container;
    document.body.appendChild(container);

    function spawnBurst(){
      const burstCount = 6 + Math.floor(Math.random()*8);
      for(let i=0;i<burstCount;i++){
        const c = document.createElement('div');
        c.className = 'confetti';
        const left = Math.random()*100;
        const skew = (Math.random()*40 - 20);
        c.style.left = left + '%';
        c.style.background = randomColor();
        const dur = (1.3 + Math.random()*1.6).toFixed(2) + 's';
        c.style.animationDuration = dur;
        c.style.animationDelay = (Math.random()*0.25)+'s';
        c.style.width = (5 + Math.random()*10) + 'px';
        c.style.height = (10 + Math.random()*20) + 'px';

        c.style.transform = `translateX(${skew}px)`;
        container.appendChild(c);

        setTimeout(()=>{ try{ if(c && c.parentNode) c.parentNode.removeChild(c); }catch(e){} }, (parseFloat(dur)*1000) + 600);
      }
    }

    spawnBurst();
    window._confettiInterval = setInterval(()=>{
      spawnBurst();
    }, 800 + Math.floor(Math.random()*600));
  }

  function stopConfettiLoop(){
    try{
      if(window._confettiInterval){ clearInterval(window._confettiInterval); window._confettiInterval = null; }
      const c = document._confettiContainer;
      if(c && c.parentNode) c.parentNode.removeChild(c);
      document._confettiContainer = null;
    }catch(e){ console.warn('stopConfettiLoop error', e); }
  }


  function launchFireworks(count = 6, ascentDuration = 900){
    const container = document._fireworksContainer || document.createElement('div');
    if(!document._fireworksContainer){ container.className = 'fireworks-container'; document.body.appendChild(container); document._fireworksContainer = container; }
    const colors = ['#FFD700','#FF5E5E','#5EE0FF','#8AFF8A','#C686FF','#FFB86B','#FF9F43'];

    for(let i=0;i<count;i++){
      const leftPct = 8 + Math.random() * 84;
      const rocket = document.createElement('div');
      rocket.className = 'firework-rocket';
      rocket.style.left = leftPct + '%';
      rocket.style.animation = `fw-rocketUp ${ascentDuration}ms ease-out forwards`;
      document._fireworksContainer.appendChild(rocket);

      setTimeout(()=>{
        try{
          const rect = rocket.getBoundingClientRect();
          const cx = rect.left + rect.width/2;
          const cy = rect.top + rect.height/2;
          const particles = 18 + Math.floor(Math.random()*8);
          for(let p=0;p<particles;p++){
            const part = document.createElement('div');
            part.className = 'firework-particle';
            const size = 6 + Math.floor(Math.random()*8);
            part.style.width = size + 'px'; part.style.height = size + 'px';
            const color = colors[Math.floor(Math.random()*colors.length)];
            part.style.background = color;
            part.style.left = (cx - size/2) + 'px';
            part.style.top = (cy - size/2) + 'px';
            const angle = Math.random()*Math.PI*2;
            const dist = 80 + Math.random()*220;
            const dx = Math.cos(angle) * dist;
            const dy = Math.sin(angle) * dist * -1;
            part.style.setProperty('--dx', dx + 'px');
            part.style.setProperty('--dy', dy + 'px');
            const dur = 700 + Math.floor(Math.random()*900);
            part.style.animation = `fw-particleFly ${dur}ms cubic-bezier(.2,.6,.2,1) forwards`;
            document._fireworksContainer.appendChild(part);
            setTimeout(()=>{ try{ if(part && part.parentNode) part.parentNode.removeChild(part); }catch(e){} }, dur + 80);
          }
        }catch(e){ console.warn('firework explode error', e); }
        try{ if(rocket && rocket.parentNode) rocket.parentNode.removeChild(rocket); }catch(e){}
      }, Math.max(220, ascentDuration - 220));
    }
  }

  function startFireworksLoop(){
    if(window._fireworksInterval) return;
    launchFireworks(6, 900);
    window._fireworksInterval = setInterval(()=> launchFireworks(4 + Math.floor(Math.random()*6), 800 + Math.floor(Math.random()*600)), 1200 + Math.floor(Math.random()*800));
  }

  function stopFireworksLoop(){
    try{
      if(window._fireworksInterval){ clearInterval(window._fireworksInterval); window._fireworksInterval = null; }
      const c = document._fireworksContainer;
      if(c && c.parentNode) c.parentNode.removeChild(c);
      document._fireworksContainer = null;
    }catch(e){ console.warn('stopFireworksLoop error', e); }
  }
</script>
<script>
  (function(){
    const canvas = document.getElementById('backgroundCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const iconImages = [
      document.getElementById('icon-artes'),
      document.getElementById('icon-ciencia'),
      document.getElementById('icon-esportes'),
      document.getElementById('icon-mundo'),
      document.getElementById('icon-variedades'),
      document.getElementById('icon-sociedade')
    ];
    const iconSize = 40; const spacing = 20; const icons = []; const speed = 0.2;
    function initIcons(){
      const cols = Math.ceil(canvas.width / (iconSize + spacing));
      const rows = Math.ceil(canvas.height / (iconSize + spacing));
      for(let row=0; row<rows; row++){
        for(let col=0; col<cols; col++){
          const iconIndex = (row + col) % iconImages.length;
          icons.push({ img: iconImages[iconIndex], x: col * (iconSize + spacing) + spacing/2, y: row * (iconSize + spacing) + spacing/2 });
        }
      }
    }
    function animate(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      icons.forEach(icon=>{
        icon.x += speed; if(icon.x > canvas.width) icon.x = -iconSize;
        try{ ctx.drawImage(icon.img, icon.x, icon.y, iconSize, iconSize); }catch(e){}
      });
      requestAnimationFrame(animate);
    }
    function startAnimation(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; icons.length = 0; initIcons(); animate(); }
    Promise.all(iconImages.map(img=>new Promise(resolve=>{ if(img.complete) resolve(); else { img.onload = resolve; img.onerror = resolve; } }))).then(startAnimation);
    window.addEventListener('resize', startAnimation);
  })();
</script>

</html>
